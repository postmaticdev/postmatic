<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lupa Password · Postmatic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <style>
      :root {
        --primary: oklch(51.59% 0.225 262.83);
        --primary-foreground: oklch(0.4911 0.225 262.83);
        --secondary: oklch(0.585 0.233 277.117);
        --secondary-foreground: oklch(0.5 0.233 277.117);
      }
      .bg-primary {
        background-color: var(--primary);
      }
      .bg-brand-gradient {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
      }
      .ring-brand:focus {
        outline: none;
        box-shadow: 0 0 0 3px color-mix(in oklab, var(--primary) 60%, #ffffff);
      }
    </style>
  </head>

  <body class="min-h-screen bg-gray-50">
    <div class="grid min-h-screen lg:grid-cols-2">
      <!-- Brand / kiri -->
      <aside
        class="hidden lg:flex flex-col justify-between p-10 bg-brand-gradient text-white"
      >
        <div>
          <div class="flex items-center gap-3">
            <div
              class="h-12 w-12 rounded-2xl bg-white/15 backdrop-blur-sm flex items-center justify-center"
            >
              <img
                src="/static/logo.png"
                alt="Postmatic"
                class="h-full w-full object-cover"
              />
            </div>
            <div class="text-2xl font-semibold tracking-tight">Postmatic</div>
          </div>

          <h1 class="mt-16 text-4xl font-semibold max-w-lg">
            Reset kata sandi Anda.
          </h1>
          <p class="mt-4 text-white/90 max-w-xl">
            Masukkan email terdaftar, kami akan mengirimkan tautan untuk
            mengatur ulang password Anda dengan aman.
          </p>

          <div class="mt-10 grid grid-cols-2 gap-4 max-w-xl">
            <div class="rounded-2xl bg-white/10 p-5">
              <p class="text-sm font-medium">Privasi</p>
              <p class="text-white/80 text-xs mt-1">
                Kami tidak pernah membagikan email Anda
              </p>
            </div>
            <div class="rounded-2xl bg-white/10 p-5">
              <p class="text-sm font-medium">Keamanan</p>
              <p class="text-white/80 text-xs mt-1">
                Tautan reset berlaku terbatas
              </p>
            </div>
          </div>
        </div>

        <div class="text-white/80 text-sm">
          &copy; <%= new Date().getFullYear() %> Postmatic. All rights reserved.
        </div>
      </aside>

      <!-- Form / kanan -->
      <main class="flex items-center justify-center p-6 sm:p-10">
        <div class="w-full max-w-md">
          <div class="bg-white shadow-xl rounded-2xl p-8">
            <div class="text-center">
              <div
                class="mx-auto h-12 w-12 rounded-2xl bg-primary flex items-center justify-center overflow-hidden"
              >
                <img
                  src="/static/logo.png"
                  alt="Postmatic"
                  class="h-full w-full object-cover"
                />
              </div>
              <h2 class="mt-5 text-2xl font-semibold text-gray-900">
                Lupa Password?
              </h2>
              <p class="mt-2 text-sm text-gray-500">
                Masukkan email Anda untuk menerima tautan reset.
              </p>
            </div>

            <% if (typeof error !== 'undefined' && error) { %>
            <div
              class="mt-6 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700"
            >
              <%= error %>
            </div>
            <% } %> <% if (typeof success !== 'undefined' && success) { %>
            <div
              class="mt-6 rounded-xl border border-green-200 bg-green-50 px-4 py-3 text-sm text-green-700"
            >
              <%= success %>
            </div>
            <% } %> <% var _email = (typeof email !== 'undefined' && email) ?
            String(email) : ''; var _afterSubmit = !!(typeof afterSubmit !==
            'undefined' && afterSubmit); var _canAt = (typeof
            canBeRequestedAgainAt !== 'undefined' && canBeRequestedAgainAt !==
            null) ? Number(canBeRequestedAgainAt) : null; var _captchaErr =
            (typeof error !== 'undefined' && error &&
            /captcha/i.test(String(error))) ? String(error) : ''; %>

            <form
              class="mt-6 space-y-5"
              method="POST"
              action="/api/auth/page/reset-password"
              id="resetForm"
              novalidate
            >
              <input
                type="hidden"
                name="_csrf"
                value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>"
              />

              <% if (typeof redirect !== 'undefined' && redirect) { %>
              <input type="hidden" name="redirect" value="<%= redirect %>" />
              <% } %>

              <!-- GROUP FIELD: disembunyikan jika afterSubmit true -->
              <div id="fieldsGroup" class="<%= _afterSubmit ? 'hidden' : '' %>">
                <label
                  for="email"
                  class="block text-sm font-medium text-gray-700"
                  >Alamat email</label
                >
                <input
                  id="email"
                  name="email"
                  type="email"
                  required
                  autocomplete="email"
                  class="mt-1 block w-full rounded-xl border border-gray-300 bg-white px-3 py-2 shadow-sm ring-brand"
                  placeholder="user@example.com"
                  value="<%= _email %>"
                />
                <p
                  id="email-error-client"
                  class="mt-2 text-sm text-red-600 hidden"
                ></p>
              </div>

              <!-- Cooldown info + Turnstile + button -->
              <div class="space-y-3">
                <p id="cooldownText" class="text-sm text-gray-600 hidden">
                  Anda dapat melakukan permintaan lagi dalam
                  <span id="cooldownTime" class="font-medium text-gray-900"
                    >00:00</span
                  >
                </p>

                <% if (TURNSTILE_ENABLED) { %>
                <div class="w-full flex items-center justify-center">
                  <div
                    class="cf-turnstile"
                    data-sitekey="<%= TURNSTILE_SITE_KEY %>"
                    data-theme="auto"
                    data-callback="pmOnTsOk"
                    data-error-callback="pmOnTsErr"
                    data-expired-callback="pmOnTsExp"
                  ></div>
                </div>
                <p
                  id="captcha-error"
                  class="mt-2 text-xs text-red-600 <%= _captchaErr ? '' : 'hidden' %>"
                >
                  <%= _captchaErr %>
                </p>
                <p
                  id="captcha-status"
                  class="mt-2 text-sm text-green-600 hidden"
                ></p>
                <script
                  src="https://challenges.cloudflare.com/turnstile/v0/api.js"
                  async
                  defer
                ></script>
                <% } %>

                <button
                  type="submit"
                  id="submitBtn"
                  data-loading-text="Mengirim..."
                  class="w-full rounded-xl bg-brand-gradient py-2.5 text-white font-medium shadow hover:opacity-95 transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2"
                  style="--tw-ring-color: var(--secondary)"
                >
                  <span class="inline-flex items-center justify-center gap-2">
                    <svg
                      class="spinner hidden animate-spin h-5 w-5 text-white"
                      viewBox="0 0 24 24"
                      aria-hidden="true"
                    >
                      <circle
                        class="opacity-25"
                        cx="12"
                        cy="12"
                        r="10"
                        stroke="currentColor"
                        stroke-width="4"
                        fill="none"
                      ></circle>
                      <path
                        class="opacity-75"
                        fill="currentColor"
                        d="M4 12a8 8 0 018-8v3.5a4.5 4.5 0 00-4.5 4.5H4z"
                      ></path>
                    </svg>
                    <span class="btn-label">Kirim Tautan Reset</span>
                  </span>
                </button>
              </div>
            </form>

            <p class="mt-6 text-center text-sm text-gray-600">
              Sudah punya akun?
              <a
                href="/api/auth/page/login"
                class="font-medium text-gray-900 hover:underline"
                >Kembali ke halaman login</a
              >
            </p>
          </div>

          <!-- Footer links with LANDINGPAGE_URL prefix -->
          <footer class="mt-6 text-center text-xs text-gray-500">
            <a
              class="hover:underline"
              href="<%= LANDINGPAGE_URL %>/cookie-policy"
              >Cookie Policy</a
            >
            ·
            <a
              class="hover:underline"
              href="<%= LANDINGPAGE_URL %>/data-deletion"
              >Data Deletion</a
            >
            ·
            <a
              class="hover:underline"
              href="<%= LANDINGPAGE_URL %>/privacy-policy"
              >Privacy Policy</a
            >
            ·
            <a
              class="hover:underline"
              href="<%= LANDINGPAGE_URL %>/terms-of-service"
              >Terms of Service</a
            >
          </footer>
        </div>
      </main>
    </div>

    <!-- Turnstile callbacks (UX opsional) -->
    <script nonce="<%= cspNonce %>">
      (function () {
        var errEl = document.getElementById("captcha-error");
        var statEl = document.getElementById("captcha-status");
        function showErr(msg) {
          if (statEl) {
            statEl.textContent = "";
            statEl.classList.add("hidden");
          }
          if (errEl) {
            errEl.textContent = msg || "Captcha tidak valid.";
            errEl.classList.remove("hidden");
          }
        }
        function showOk(msg) {
          if (errEl) {
            errEl.textContent = "";
            errEl.classList.add("hidden");
          }
          if (statEl) {
            statEl.textContent = msg || "Captcha terverifikasi.";
            statEl.classList.remove("hidden");
          }
        }
        window.pmOnTsOk = function (token) {
          showOk();
        };
        window.pmOnTsErr = function () {
          showErr("Captcha gagal dimuat. Silakan muat ulang atau coba lagi.");
        };
        window.pmOnTsExp = function () {
          showErr("Captcha kedaluwarsa. Silakan selesaikan ulang captcha.");
        };
      })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/zod@3.23.8/lib/index.umd.min.js"></script>
    <script nonce="<%= cspNonce %>">
      (function () {
        // Data dari server (aman via JSON)
        var SERVER_EMAIL = <%- JSON.stringify(_email) %>;
        var AFTER_SUBMIT = <%- JSON.stringify(_afterSubmit) %>;
        var CAN_AT = <%- JSON.stringify(_canAt) %>; // epoch ms kapan boleh request lagi, atau null

        const form = document.getElementById("resetForm");
        if (!form) return;

        const btn = form.querySelector("#submitBtn");
        const spinner = btn ? btn.querySelector(".spinner") : null;
        const label = btn ? btn.querySelector(".btn-label") : null;
        const emailInput = form.querySelector("#email");
        const emailErr = document.getElementById("email-error-client");
        const cooldownText = document.getElementById("cooldownText");
        const cooldownTime = document.getElementById("cooldownTime");
        const fieldsGroup = document.getElementById("fieldsGroup");
        const loadingText = (btn && btn.getAttribute("data-loading-text")) || "Mengirim...";

        // Prefill email dari server
        if (emailInput && SERVER_EMAIL && !emailInput.value) {
          emailInput.value = SERVER_EMAIL;
        }

        // Countdown util
        function fmt(ms) {
          ms = Math.max(0, ms|0);
          const s = Math.floor(ms / 1000);
          const mm = String(Math.floor(s / 60)).padStart(2, "0");
          const ss = String(s % 60).padStart(2, "0");
          return mm + ":" + ss;
        }
        function setBtnDisabled(disabled) {
          if (!btn) return;
          btn.disabled = disabled;
          if (disabled) {
            btn.classList.add("opacity-75", "cursor-not-allowed");
            btn.setAttribute("aria-disabled", "true");
          } else {
            btn.classList.remove("opacity-75", "cursor-not-allowed");
            btn.removeAttribute("aria-disabled");
          }
        }

        // Inisialisasi countdown jika CAN_AT valid & di masa depan
        let timer = null;
        const now = Date.now();
        if (typeof CAN_AT === "number" && CAN_AT > now) {
          const tick = () => {
            const left = CAN_AT - Date.now();
            if (left <= 0) {
              if (timer) { clearInterval(timer); timer = null; }
              if (cooldownText) cooldownText.classList.add("hidden");
              if (label) label.textContent = "Kirim Tautan Reset";
              setBtnDisabled(false);
              return;
            }
            if (cooldownText) cooldownText.classList.remove("hidden");
            if (cooldownTime) cooldownTime.textContent = fmt(left);
            if (label) label.textContent = "Tunggu " + fmt(left);
            setBtnDisabled(true);
          };
          tick();
          timer = setInterval(tick, 250);
        } else {
          if (cooldownText) cooldownText.classList.add("hidden");
          setBtnDisabled(false);
        }

        // Sembunyikan field jika afterSubmit
        if (AFTER_SUBMIT && fieldsGroup) {
          fieldsGroup.classList.add("hidden");
        }

        // Validasi (Zod)
        const z = window.zod || window.Zod;
        const Schema = z.object({
          email: z.string().trim().min(1, "Email wajib diisi").email("Format email tidak valid"),
        });

        let submitting = false;

        form.addEventListener("submit", function (e) {
          e.preventDefault();
          if (submitting) return;
          if (btn && btn.disabled) return; // masih cooldown

          if (emailErr) { emailErr.textContent = ""; emailErr.classList.add("hidden"); }
          emailInput?.removeAttribute("aria-invalid");

          const data = { email: emailInput ? emailInput.value : SERVER_EMAIL || "" };
          const result = Schema.safeParse(data);

          if (!result.success) {
            const issue = result.error.issues[0];
            if (emailErr) { emailErr.textContent = issue.message; emailErr.classList.remove("hidden"); }
            emailInput?.focus();
            emailInput?.setAttribute("aria-invalid", "true");
            return;
          }

          // Loading state tombol
          submitting = true;
          if (btn) {
            btn.disabled = true;
            btn.setAttribute("aria-busy", "true");
            btn.classList.add("opacity-75", "cursor-not-allowed");
            if (spinner) spinner.classList.remove("hidden");
            if (label) {
              btn.setAttribute("data-original-text", label.textContent || "");
              label.textContent = loadingText;
            }
          }

          requestAnimationFrame(() => form.submit());
        });

        // Bersihkan error saat user mengetik (kalau field tampak)
        emailInput?.addEventListener("input", function () {
          if (emailErr && !emailErr.classList.contains("hidden")) {
            emailErr.textContent = "";
            emailErr.classList.add("hidden");
          }
          emailInput.removeAttribute("aria-invalid");
        });

        // Pulihkan bila kembali via bfcache
        window.addEventListener("pageshow", function (e) {
          if (!e.persisted) return;
          submitting = false;
          if (btn) {
            btn.disabled = false;
            btn.removeAttribute("aria-busy");
            btn.classList.remove("opacity-75", "cursor-not-allowed");
            if (spinner) spinner.classList.add("hidden");
            const original = btn.getAttribute("data-original-text");
            if (label && original != null) label.textContent = original;
          }
        });
      })();
    </script>
  </body>
</html>
